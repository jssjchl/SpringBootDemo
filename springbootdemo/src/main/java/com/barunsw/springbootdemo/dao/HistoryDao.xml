<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.barunsw.springbootdemo.dao.HistoryDao">
	<sql id ="where">
	  WHERE
	    DATE_FORMAT(EVENT_TIME, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startDate}, '%Y-%m-%d') AND DATE_FORMAT(#{endDate}, '%Y-%m-%d')
	    AND
	    <choose>
			<when test = "coloumType == 'ID'">
				OPERATOR_ID like CONCAT('%', #{searchData},'%')
	 		</when>
			<when test = "coloumType == 'IP'">
				 OPERATOR_IP like CONCAT('%', #{searchData},'%')
			</when>
			<when test = "coloumType == 'Param'">
				 PARAM like CONCAT('%', #{searchData},'%')
			</when>
			<when test = "coloumType == 'Result'">
				 result like CONCAT('%', #{searchData},'%')
			</when>
			<when test = "coloumType == 'Reason'">
				 result like CONCAT('%', #{searchData},'%')
			</when>
			<when test = "coloumType == 'URL'">
				 URL like CONCAT('%', #{searchData},'%')
			</when>
			<otherwise>
				1 = 1
			</otherwise>
		</choose>		
	</sql>
	
	<insert id ="insertHistory"
		parameterType="com.barunsw.springbootdemo.vo.HistoryVo">
		INSERT INTO 
			TB_HISTORY(URL, OPERATOR_ID, OPERATOR_IP, PARAM, RESULT, REASON)
		VALUE
			(#{url},#{operatorId},#{operatorIp},#{param},#{result},#{reason})
	</insert>

	<select id="countHistory" resultType="int">
	SELECT 
		COUNT(*)
		FROM
			TB_HISTORY
		<include refid ="where"></include>
		ORDER BY SEQ DESC
	</select>
	
 	<select id ="searchHistoryDataList"
 		resultType="com.barunsw.springbootdemo.vo.HistoryVo"
		parameterType="com.barunsw.springbootdemo.vo.HistoryVo">
				
		SELECT 
			a.SEQ
			, a.URL
			, DATE_FORMAT(a.EVENT_TIME, '%Y-%m-%d %H:%i:%s') as eventTime 
			, a.OPERATOR_ID as operatorId
			, a.OPERATOR_IP as operatorIp
			, a.PARAM
			, a.RESULT
			, a.REASON
			, @rownum := @rownum + 1 as rn
		FROM
		( SELECT
			*
		  FROM
			TB_HISTORY
	    <include refid ="where"></include>
		  ORDER BY EVENT_TIME DESC 
		  LIMIT #{offset}, #{pagesize}) AS A
		  , (SELECT @ROWNUM := #{offset}) AS R
	</select> 
	
</mapper>